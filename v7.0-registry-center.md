# marpc v7.0 自定义注册中心接入说明

## 功能概述

实现了 v7.0 版本中注册中心可插拔的功能，支持通过配置在 Zookeeper 和自定义 Maregistry 之间切换。

## 实现内容

### 1. 新增组件

- **MaregistryCenter.java**: 基于 HTTP 协议的自定义注册中心实现
- **配置增强**: 在 MarpcConfig 中添加注册中心类型配置支持

### 2. 核心特性

- **配置驱动**: 通过 `marpc.registry.type` 配置项切换注册中心
- **向后兼容**: 默认使用 Zookeeper，保留原有功能
- **HTTP 协议**: 使用 OkHttp 与注册中心服务通信
- **定时轮询**: 自动检测服务实例变更
- **缓存机制**: 网络异常时使用本地缓存数据

## 配置说明

### application.yaml 配置示例

```yaml
marpc:
  # 注册中心类型配置 - 可选: zookeeper | maregistry
  registry:
    type: zookeeper  # 默认值
  
  # Zookeeper 配置（保留向后兼容）
  zk:
    address: localhost:2181
  
  # Maregistry 配置
  maregistry:
    address: http://localhost:8081
  
  # 其他通用配置
  app: marpc-app
  env: dev
```

### 切换注册中心

#### 使用 Zookeeper（默认）
```yaml
marpc:
  registry:
    type: zookeeper
  zk:
    address: localhost:2181
```

#### 使用 Maregistry
```yaml
marpc:
  registry:
    type: maregistry
  maregistry:
    address: http://your-registry-server:8081
```

## API 接口规范

MaregistryCenter 期望注册中心服务提供以下 RESTful API：

### 1. 服务注册
```
POST /api/register?app={app}&env={env}&service={service}&instance={instance}
```

### 2. 服务注销
```
DELETE /api/unregister?app={app}&env={env}&service={service}&instance={instance}
```

### 3. 获取实例列表
```
GET /api/instances?app={app}&env={env}&service={service}
```
返回格式：JSON 数组 `["host1:port1", "host2:port2"]`

## 使用示例

### Provider 端配置
```yaml
# 使用 Maregistry
marpc:
  registry:
    type: maregistry
  maregistry:
    address: http://registry.example.com:8081
  app: my-provider-app
  env: prod
```

### Consumer 端配置
```yaml
# 使用相同的注册中心配置
marpc:
  registry:
    type: maregistry
  maregistry:
    address: http://registry.example.com:8081
  app: my-consumer-app
  env: prod
```

## 测试验证

### 单元测试
```bash
# 运行注册中心相关测试
mvn test -Dtest=MaregistryCenterTest
```

### 功能验证
1. 启动 Maregistry 服务（需要单独部署）
2. 配置 marpc 应用使用 maregistry 类型
3. 启动 Provider 和 Consumer 验证服务注册与发现

## 注意事项

1. **网络依赖**: Maregistry 模式需要网络可达的注册中心服务
2. **容错机制**: 网络异常时会使用缓存数据继续工作
3. **定时检查**: 每5秒轮询检查服务变更
4. **资源清理**: 应用关闭时会自动清理连接和线程资源
5. **配置优先级**: 当 registry.type 配置无效时，默认回退到 Zookeeper

## 扩展性

该设计支持轻松扩展其他注册中心实现：
1. 实现 RegistryCenter 接口
2. 在 MarpcConfig 中添加相应的条件判断
3. 添加对应的配置项